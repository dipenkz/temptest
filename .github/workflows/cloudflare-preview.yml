name: Cloudflare Preview (Stable PR Source Preview)

on:
  workflow_dispatch:
  push:
    branches-ignore: [main]
  pull_request_target:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write
  deployments: write

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1. Checkout PR SOURCE code (CRITICAL FIX)
      # ------------------------------------------------------------
      - name: Checkout PR source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # ------------------------------------------------------------
      # 2. Setup Node
      # ------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      # ------------------------------------------------------------
      # 3. Install dependencies
      # ------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # ------------------------------------------------------------
      # 4. Build static site (Next.js export)
      # next.config.ts must contain: export default { output: "export" }
      # ------------------------------------------------------------
      - name: Build (static export)
        run: npm run build

      # ------------------------------------------------------------
      # 5. Deploy to Cloudflare Pages
      # ------------------------------------------------------------
      - name: Deploy to Cloudflare Pages
        id: cf
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ci-cd-static-page-preview
          directory: out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref || github.ref_name }}
          wranglerVersion: 4

      # ------------------------------------------------------------
      # 6. Compute STABLE preview URL from SOURCE branch name
      # ------------------------------------------------------------
      - name: Compute stable preview URL
        id: url
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          SAFE=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9._-]#-#g')
          echo "url=https://${SAFE}.ci-cd-static-page-preview.pages.dev" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # 7. Count existing PR comments (issue + review)
      # ------------------------------------------------------------
      - name: Count PR comments
        id: count
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request?.number;

            let issue = 0;
            let review = 0;

            if (pr) {
              issue = (await github.paginate(
                github.rest.issues.listComments,
                { owner, repo, issue_number: pr, per_page: 100 }
              )).length;

              review = (await github.paginate(
                github.rest.pulls.listReviewComments,
                { owner, repo, pull_number: pr, per_page: 100 }
              )).length;
            }

            core.setOutput('issue', String(issue));
            core.setOutput('review', String(review));
            core.setOutput('total', String(issue + review));

      # ------------------------------------------------------------
      # 8. Post preview comment ONLY if no comments exist
      # ------------------------------------------------------------
      - name: Post PR preview comment (only once)
        if: ${{ github.event_name == 'pull_request_target' && steps.count.outputs.total == '0' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ðŸš€ **Preview for `${{ github.head_ref }}`**

            ðŸ”— **Stable Preview URL**  
            ${{ steps.url.outputs.url }}

            âœ… Built from **PR source branch**  
            ðŸ”„ Updates automatically on every push

      # ------------------------------------------------------------
      # 9. Debug output (logs only)
      # ------------------------------------------------------------
      - name: Print comment totals
        run: |
          echo "PR issue comments: ${{ steps.count.outputs.issue }}"
          echo "PR review comments: ${{ steps.count.outputs.review }}"
          echo "Total PR comments: ${{ steps.count.outputs.total }}"

      - name: Comment on commit (if 0 comments)
        if: ${{ github.event_name == 'push'  && steps.count.outputs.total == '0' }}
        uses: peter-evans/commit-comment@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          sha: ${{ github.sha }}
          body: |
            ðŸš€ **Preview for `${{ github.ref_name || github.head_ref }}`**
            ðŸ”— ${{ steps.url.outputs.url }}
